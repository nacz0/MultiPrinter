<!doctype html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MultiPrinter A4</title>
  <style>
    :root {
      --bg: #f2f4f7;
      --surface: #ffffff;
      --ink: #1f2933;
      --muted: #637083;
      --accent: #0f766e;
      --line: #d9e2ec;
      --danger: #b42318;
      --page-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 15% 10%, #d9f0ec 0%, transparent 30%),
        radial-gradient(circle at 95% 5%, #e3eef9 0%, transparent 34%),
        var(--bg);
      min-height: 100vh;
    }

    .app {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 20px;
    }

    .panel,
    .preview-wrap,
    .layout-panel {
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: 14px;
    }

    .workspace {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 340px;
      gap: 20px;
      align-items: start;
    }

    .panel {
      padding: 16px;
      position: sticky;
      top: 14px;
      height: fit-content;
      max-height: calc(100vh - 28px);
      overflow-y: auto;
      overscroll-behavior: contain;
    }

    .layout-panel {
      padding: 16px;
      position: sticky;
      top: 14px;
      max-height: calc(100vh - 28px);
      overflow-y: auto;
      overscroll-behavior: contain;
    }

    .panel-header {
      margin-bottom: 14px;
      padding-bottom: 12px;
      border-bottom: 1px solid #edf2f7;
    }

    h1 {
      margin: 0 0 6px;
      font-size: 1.3rem;
      letter-spacing: 0.2px;
    }

    .subtitle {
      margin: 0;
      color: var(--muted);
      font-size: 0.95rem;
      line-height: 1.35;
    }

    .sidebar-section {
      margin-bottom: 12px;
      padding: 12px;
      border: 1px solid #e5edf6;
      border-radius: 12px;
      background: #fcfdff;
    }

    .section-title {
      margin: 0 0 10px;
      font-size: 0.86rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: #526071;
      font-weight: 700;
    }

    .control {
      margin-bottom: 10px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-size: 0.88rem;
      font-weight: 600;
      color: var(--ink);
    }

    input,
    select,
    button {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 0.95rem;
      font: inherit;
      background: #fff;
      color: var(--ink);
    }

    select {
      padding-right: 36px;
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
    }

    input:focus,
    select:focus,
    button:focus {
      outline: 2px solid #99f6e4;
      outline-offset: 1px;
      border-color: var(--accent);
    }

    input[type="file"] {
      padding: 8px;
    }

    .visually-hidden {
      position: absolute !important;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0 0 0 0);
      white-space: nowrap;
      border: 0;
    }

    .folder-picker {
      display: flex;
      align-items: center;
      gap: 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 8px 10px;
      background: #fff;
      min-height: 52px;
    }

    .folder-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin: 0;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #c6d4e6;
      background: #f8fbff;
      color: var(--ink);
      font-size: 0.9rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.12s ease, border-color 0.12s ease;
      flex: 0 0 auto;
    }

    .folder-btn:hover {
      background: #eef6ff;
      border-color: #a8bfd8;
    }

    .folder-status {
      color: var(--muted);
      font-size: 0.9rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .actions button {
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.12s ease;
      white-space: nowrap;
    }

    .actions button:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(15, 118, 110, 0.15);
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    .btn-secondary {
      background: #fff;
      color: var(--ink);
    }

    .meta {
      margin-top: 0;
      padding: 10px 12px;
      background: #f8fafc;
      border: 1px solid var(--line);
      border-radius: 10px;
      font-size: 0.9rem;
      color: var(--muted);
      line-height: 1.4;
    }

    .meta strong { color: var(--ink); }

    .crop-tools {
      margin-top: 0;
      padding: 0;
      background: transparent;
      border: 0;
      border-radius: 0;
    }

    .crop-title {
      margin: 0 0 8px;
      font-size: 0.88rem;
      font-weight: 700;
    }

    .crop-selected {
      margin: 0 0 8px;
      font-size: 0.86rem;
      color: var(--muted);
      min-height: 2.5em;
    }

    .nudge-grid {
      display: grid;
      grid-template-columns: repeat(3, 84px);
      grid-template-rows: repeat(2, 52px);
      justify-content: center;
      align-items: center;
      gap: 8px 10px;
      margin: 2px 0 10px;
    }

    .nudge-grid button {
      height: 52px;
      padding: 0;
      border-radius: 8px;
      font-weight: 700;
      font-size: 1.7rem;
      line-height: 1;
      cursor: pointer;
    }

    .nudge-grid span {
      width: 84px;
      height: 52px;
      visibility: hidden;
      pointer-events: none;
    }

    #nudgeUpBtn {
      grid-column: 2;
      grid-row: 1;
    }

    #nudgeLeftBtn {
      grid-column: 1;
      grid-row: 2;
    }

    #nudgeDownBtn {
      grid-column: 2;
      grid-row: 2;
    }

    #nudgeRightBtn {
      grid-column: 3;
      grid-row: 2;
    }

    .nudge-step {
      display: grid;
      grid-template-columns: 1fr 108px;
      gap: 8px;
      align-items: center;
    }

    .nudge-step label {
      margin: 0;
      font-size: 0.84rem;
      color: var(--muted);
    }

    .nudge-step input {
      padding: 7px 8px;
      font-size: 0.86rem;
    }

    .nudge-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 8px;
    }

    .selected-controls {
      margin-top: 8px;
      display: grid;
      gap: 8px;
    }

    .selected-controls .inline {
      display: grid;
      grid-template-columns: 1fr 90px;
      gap: 8px;
      align-items: center;
    }

    .selected-controls input[type="range"] {
      padding: 0;
    }

    .error {
      margin-top: 10px;
      color: var(--danger);
      font-size: 0.9rem;
      min-height: 1.2em;
    }

    .preview-wrap {
      padding: 16px;
      min-height: 78vh;
    }

    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 14px;
    }

    .preview-header h2 {
      margin: 0;
      font-size: 1.1rem;
    }

    .preview-header p {
      margin: 0;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .pages {
      display: grid;
      gap: 18px;
      justify-content: center;
    }

    .sheet {
      background: white;
      box-shadow: var(--page-shadow);
      border: 1px solid #e5e7eb;
      position: relative;
      overflow: hidden;
      transform-origin: top center;
    }

    .sheet-grid {
      width: 100%;
      height: 100%;
      display: grid;
      align-content: stretch;
      justify-content: stretch;
      background: #fff;
    }

    .photo-cell {
      background: #f3f4f6;
      border: 1px solid #eceff3;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .photo-cell img {
      width: 100%;
      height: 100%;
      object-position: center;
      display: block;
    }

    .photo-cell .fit-contain { object-fit: contain; background: #f8fafc; }
    .photo-cell .fit-cover { object-fit: cover; }
    .photo-cell.barfill-white { background: #ffffff; }
    .photo-cell.barfill-black { background: #111111; }
    .photo-cell.barfill-blur { background: #1f2933; }
    .photo-cell.barfill-blur .fit-contain { background: transparent; }
    .photo-cell .photo-bg {
      position: absolute;
      inset: 0;
      overflow: hidden;
      pointer-events: none;
      z-index: 0;
    }
    .photo-cell .photo-bg::after {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(16, 24, 40, 0.16);
    }
    .photo-cell .photo-bg img {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: cover;
      object-position: center;
      transform: scale(1.1);
      filter: blur(13px) saturate(0.9) brightness(0.92);
      opacity: 0.82;
    }
    .photo-cell > img {
      position: relative;
      z-index: 1;
    }
    .photo-cell.is-pannable { cursor: grab; }
    .photo-cell.is-pannable.dragging { cursor: grabbing; }
    .photo-cell.is-selected {
      outline: 3px solid #0f766e;
      outline-offset: -3px;
    }
    .photo-cell.is-pannable img {
      user-select: none;
      -webkit-user-drag: none;
      touch-action: none;
      pointer-events: none;
    }

    .cell-label {
      position: absolute;
      bottom: 4px;
      right: 4px;
      background: rgba(17, 24, 39, 0.7);
      color: #fff;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 6px;
      pointer-events: none;
    }

    .sheet-number {
      position: absolute;
      top: 6px;
      left: 8px;
      color: #6b7280;
      font-size: 12px;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.9);
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
    }

    @media (max-width: 1240px) {
      .workspace {
        grid-template-columns: 1fr;
      }

      .layout-panel {
        position: static;
        max-height: none;
      }
    }

    @media (max-width: 1040px) {
      .app {
        grid-template-columns: 1fr;
      }

      .panel {
        position: static;
        max-height: none;
      }
    }

    @media print {
      :root {
        --print-scale: 1;
      }

      body {
        margin: 0;
        background: #fff;
      }

      .panel,
      .layout-panel,
      .preview-header,
      .sheet-number,
      .cell-label {
        display: none !important;
      }

      .app,
      .workspace,
      .preview-wrap,
      .pages {
        margin: 0;
        padding: 0;
        border: 0;
        box-shadow: none;
        max-width: none;
        width: auto;
      }

      .pages {
        display: block;
        gap: 0 !important;
      }

      .sheet {
        margin: 0;
        border: 0;
        box-shadow: none;
        break-after: page;
        page-break-after: always;
        break-inside: avoid;
        page-break-inside: avoid;
      }

      .sheet:last-child {
        break-after: auto;
        page-break-after: auto;
      }

      @page {
        size: A4 portrait;
        margin: 0;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="panel">
      <div class="panel-header">
        <h1>Edycja zdjęcia</h1>
        <p class="subtitle">Zaznacz zdjęcie w podglądzie i dopasuj jego kadr, zoom oraz obrót.</p>
      </div>

      <section class="sidebar-section">
        <div class="crop-tools">
          <p class="crop-title">Precyzyjne kadrowanie</p>
          <p id="selectedCropInfo" class="crop-selected">Kliknij zdjęcie w podglądzie, aby je wybrać.</p>
          <div class="nudge-grid">
            <button id="nudgeUpBtn" type="button" aria-label="Przesuń kadr w górę">↑</button>
            <span></span>
            <span></span>
            <button id="nudgeLeftBtn" type="button" aria-label="Przesuń kadr w lewo">←</button>
            <button id="nudgeDownBtn" type="button" aria-label="Przesuń kadr w dół">↓</button>
            <button id="nudgeRightBtn" type="button" aria-label="Przesuń kadr w prawo">→</button>
          </div>
          <div class="nudge-step">
            <label for="nudgeStepInput">Krok przesunięcia (%)</label>
            <input id="nudgeStepInput" type="number" min="0.5" max="20" step="0.5" value="2" />
          </div>
          <div class="selected-controls">
            <div class="inline">
              <label for="zoomRangeInput">Zoom (%)</label>
              <input id="zoomValueInput" type="number" min="50" max="250" step="1" value="100" />
            </div>
            <input id="zoomRangeInput" type="range" min="50" max="250" step="1" value="100" />
          </div>
          <div class="nudge-actions">
            <button id="rotateLeftBtn" type="button">Obróć -90°</button>
            <button id="rotateRightBtn" type="button">Obróć +90°</button>
          </div>
          <div class="actions">
            <button id="resetSelectedCropBtn" class="btn-secondary" type="button">Reset wybranego zdjęcia</button>
          </div>
        </div>
      </section>
    </aside>

    <main class="workspace">
      <section class="preview-wrap">
        <div class="preview-header">
          <h2>Podgląd stron A4</h2>
          <p>Sprawdź układ i użyj „Drukuj / PDF”.</p>
        </div>
        <section id="pages" class="pages"></section>
      </section>

      <aside class="layout-panel">
        <div class="panel-header">
          <h1>Ustawienia układu</h1>
          <p class="subtitle">Wybierz folder, format siatki i parametry wydruku całej strony.</p>
        </div>

        <section class="sidebar-section">
          <p class="section-title">Pliki</p>
          <div class="control">
            <label for="folderInput">Folder ze zdjęciami</label>
            <div class="folder-picker">
              <input id="folderInput" class="visually-hidden" type="file" webkitdirectory directory multiple accept="image/*" />
              <label for="folderInput" class="folder-btn">Wybierz folder</label>
              <span id="folderStatus" class="folder-status">Nie wybrano folderu</span>
            </div>
          </div>
        </section>

        <section class="sidebar-section">
          <p class="section-title">Układ Strony</p>
          <div class="row">
            <div class="control">
              <label for="photosPerPage">Zdjęć na stronę</label>
              <input id="photosPerPage" type="number" min="1" max="64" value="6" />
            </div>
            <div class="control">
              <label for="orientation">Orientacja A4</label>
              <select id="orientation">
                <option value="portrait">Pionowa</option>
                <option value="landscape">Pozioma</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="control">
              <label for="marginMm">Margines (mm)</label>
              <input id="marginMm" type="number" min="0" max="40" step="1" value="8" />
            </div>
            <div class="control">
              <label for="gapMm">Odstęp (mm)</label>
              <input id="gapMm" type="number" min="0" max="20" step="1" value="3" />
            </div>
          </div>

          <div class="control">
            <label for="layoutTemplate">Szablon układu</label>
            <select id="layoutTemplate">
              <option value="auto">Auto (siatka)</option>
              <option value="grid4">2 × 2 (4 zdjęcia)</option>
              <option value="grid6">3 × 2 (6 zdjęć)</option>
              <option value="hero5">1 duże + 4 małe (5 zdjęć)</option>
            </select>
          </div>

          <div class="control">
            <label for="fitMode">Dopasowanie zdjęcia</label>
            <select id="fitMode">
              <option value="cover">Wypełnij (przytnij)</option>
              <option value="contain">Całe zdjęcie (paski)</option>
            </select>
          </div>
          <div class="control">
            <label for="barFillMode">Wypełnienie pasków</label>
            <select id="barFillMode">
              <option value="white">Białe</option>
              <option value="blur">Rozmyte tło</option>
              <option value="black">Czarne</option>
            </select>
          </div>

          <div class="control">
            <label for="showLabels">Numeracja komórek</label>
            <select id="showLabels">
              <option value="no">Nie</option>
              <option value="yes">Tak</option>
            </select>
          </div>

          <div class="actions">
            <button id="renderBtn" class="btn-secondary" type="button">Odśwież układ</button>
            <button id="printBtn" class="btn-primary" type="button">Drukuj / PDF</button>
          </div>
          <div class="actions">
            <button id="resetCropBtn" class="btn-secondary" type="button">Reset kadrowania</button>
          </div>
        </section>

        <section class="sidebar-section">
          <p class="section-title">Podsumowanie</p>
          <div id="meta" class="meta">Brak załadowanych zdjęć.</div>
        </section>
        <div id="error" class="error" aria-live="polite"></div>
      </aside>
    </main>
  </div>

  <script>
    const MM_TO_PX = 3.7795275591;
    const A4_PORTRAIT = { widthMm: 210, heightMm: 297 };

    const folderInput = document.getElementById('folderInput');
    const folderStatusEl = document.getElementById('folderStatus');
    const photosPerPageInput = document.getElementById('photosPerPage');
    const orientationSelect = document.getElementById('orientation');
    const marginInput = document.getElementById('marginMm');
    const gapInput = document.getElementById('gapMm');
    const layoutTemplateSelect = document.getElementById('layoutTemplate');
    const fitModeSelect = document.getElementById('fitMode');
    const barFillModeSelect = document.getElementById('barFillMode');
    const showLabelsSelect = document.getElementById('showLabels');
    const renderBtn = document.getElementById('renderBtn');
    const printBtn = document.getElementById('printBtn');
    const resetCropBtn = document.getElementById('resetCropBtn');
    const selectedCropInfoEl = document.getElementById('selectedCropInfo');
    const nudgeStepInput = document.getElementById('nudgeStepInput');
    const nudgeUpBtn = document.getElementById('nudgeUpBtn');
    const nudgeDownBtn = document.getElementById('nudgeDownBtn');
    const nudgeLeftBtn = document.getElementById('nudgeLeftBtn');
    const nudgeRightBtn = document.getElementById('nudgeRightBtn');
    const zoomRangeInput = document.getElementById('zoomRangeInput');
    const zoomValueInput = document.getElementById('zoomValueInput');
    const rotateLeftBtn = document.getElementById('rotateLeftBtn');
    const rotateRightBtn = document.getElementById('rotateRightBtn');
    const resetSelectedCropBtn = document.getElementById('resetSelectedCropBtn');
    const pagesEl = document.getElementById('pages');
    const metaEl = document.getElementById('meta');
    const errorEl = document.getElementById('error');

    const LOCAL_STORAGE_CROPS_KEY = 'multiPrinter.cropPositions.v1';
    let imageItems = [];
    const cropPositions = new Map();
    let selectedItemId = null;
    let selectedItemName = '';
    let cropPersistTimer = null;

    const byNameAsc = (a, b) => a.name.localeCompare(b.name, 'pl', { numeric: true, sensitivity: 'base' });

    function setError(message) {
      errorEl.textContent = message || '';
    }

    function updateFolderStatus(files, imageCount) {
      if (!folderStatusEl) {
        return;
      }

      if (!files || !files.length) {
        folderStatusEl.textContent = 'Nie wybrano folderu';
        return;
      }

      const first = files[0];
      const relativePath = first.webkitRelativePath || first.name || '';
      const folderName = relativePath.split('/')[0] || 'Folder';
      folderStatusEl.textContent = `${folderName} • zdjęć: ${imageCount}`;
    }

    function scheduleCropPersist() {
      if (cropPersistTimer) {
        clearTimeout(cropPersistTimer);
      }
      cropPersistTimer = setTimeout(() => {
        persistCropPositionsNow();
      }, 120);
    }

    function persistCropPositionsNow() {
      const serialized = {};
      cropPositions.forEach((pos, id) => {
        serialized[id] = {
          x: Number(pos.x.toFixed(2)),
          y: Number(pos.y.toFixed(2)),
          zoom: Number(pos.zoom.toFixed(2)),
          rotation: normalizeRotation(pos.rotation),
        };
      });
      try {
        localStorage.setItem(LOCAL_STORAGE_CROPS_KEY, JSON.stringify(serialized));
      } catch (error) {
        // Ignore storage errors to keep the app usable in private mode.
      }
    }

    function loadCropPositionsFromStorage() {
      let raw = null;
      try {
        raw = localStorage.getItem(LOCAL_STORAGE_CROPS_KEY);
      } catch (error) {
        raw = null;
      }
      if (!raw) {
        return;
      }

      try {
        const parsed = JSON.parse(raw);
        Object.entries(parsed).forEach(([id, pos]) => {
          const x = typeof pos?.x === 'number' ? clamp(pos.x, 0, 100) : 50;
          const y = typeof pos?.y === 'number' ? clamp(pos.y, 0, 100) : 50;
          const zoom = typeof pos?.zoom === 'number' ? clamp(pos.zoom, 50, 250) : 100;
          const rotation = typeof pos?.rotation === 'number' ? normalizeRotation(pos.rotation) : 0;
          cropPositions.set(id, { x, y, zoom, rotation });
        });
      } catch (error) {
        // Ignore invalid localStorage payload.
      }
    }

    function setNudgeButtonsDisabled(disabled) {
      [
        nudgeUpBtn,
        nudgeDownBtn,
        nudgeLeftBtn,
        nudgeRightBtn,
        rotateLeftBtn,
        rotateRightBtn,
        resetSelectedCropBtn,
        zoomRangeInput,
        zoomValueInput,
      ].forEach((button) => {
        button.disabled = disabled;
      });
    }

    function refreshSelectionStyles() {
      const cells = pagesEl.querySelectorAll('.photo-cell[data-item-id]');
      cells.forEach((cell) => {
        cell.classList.toggle('is-selected', cell.dataset.itemId === selectedItemId);
      });
    }

    function updateSelectedCropInfo() {
      if (!selectedItemId) {
        selectedCropInfoEl.textContent = 'Kliknij zdjęcie w podglądzie, aby je wybrać.';
        setNudgeButtonsDisabled(true);
        return;
      }
      const pos = getCropPosition(selectedItemId);
      selectedCropInfoEl.textContent = `${selectedItemName} | X: ${pos.x.toFixed(1)}% | Y: ${pos.y.toFixed(1)}% | Zoom: ${Math.round(pos.zoom)}% | Rot: ${pos.rotation}°`;
      zoomRangeInput.value = String(Math.round(pos.zoom));
      zoomValueInput.value = String(Math.round(pos.zoom));
      setNudgeButtonsDisabled(false);
    }

    function selectItem(itemId, itemName) {
      selectedItemId = itemId;
      selectedItemName = itemName;
      refreshSelectionStyles();
      updateSelectedCropInfo();
    }

    function applyCropToVisibleImages(itemId) {
      const images = pagesEl.querySelectorAll('img[data-item-id]');
      images.forEach((img) => {
        if (img.dataset.itemId === itemId) {
          applyObjectPosition(img, itemId);
        }
      });
    }

    function clamp(value, min, max) {
      return Math.max(min, Math.min(max, value));
    }

    function chooseGrid(count, widthMm, heightMm) {
      let best = null;
      for (let cols = 1; cols <= count; cols += 1) {
        const rows = Math.ceil(count / cols);
        const cellW = widthMm / cols;
        const cellH = heightMm / rows;
        const ratio = cellW / cellH;
        const distanceFromPhotoRatio = Math.abs(Math.log(ratio / (3 / 2)));
        const emptySlots = (rows * cols) - count;
        const score = distanceFromPhotoRatio + (emptySlots * 0.08);

        if (!best || score < best.score) {
          best = { cols, rows, score };
        }
      }
      return { cols: best.cols, rows: best.rows };
    }

    function chunkArray(array, size) {
      const chunks = [];
      for (let i = 0; i < array.length; i += size) {
        chunks.push(array.slice(i, i + size));
      }
      return chunks;
    }

    function toPx(mm) {
      return Math.round(mm * MM_TO_PX);
    }

    function getA4SizeMm(orientation) {
      if (orientation === 'landscape') {
        return { widthMm: A4_PORTRAIT.heightMm, heightMm: A4_PORTRAIT.widthMm };
      }
      return { ...A4_PORTRAIT };
    }

    function normalizeRotation(rotation) {
      const raw = Number(rotation) || 0;
      const normalized = ((raw % 360) + 360) % 360;
      return normalized;
    }

    function getCropPosition(itemId) {
      const existing = cropPositions.get(itemId);
      if (existing) {
        return existing;
      }
      const centered = { x: 50, y: 50, zoom: 100, rotation: 0 };
      cropPositions.set(itemId, centered);
      return centered;
    }

    function setCropPosition(itemId, x, y, zoom, rotation) {
      const current = getCropPosition(itemId);
      cropPositions.set(itemId, {
        x: clamp(typeof x === 'number' ? x : current.x, 0, 100),
        y: clamp(typeof y === 'number' ? y : current.y, 0, 100),
        zoom: clamp(typeof zoom === 'number' ? zoom : current.zoom, 50, 250),
        rotation: normalizeRotation(typeof rotation === 'number' ? rotation : current.rotation),
      });
      scheduleCropPersist();
      if (selectedItemId === itemId) {
        updateSelectedCropInfo();
      }
    }

    function applyObjectPosition(img, itemId) {
      const pos = getCropPosition(itemId);
      const baseFit = img.dataset.fitMode || 'cover';
      img.style.objectPosition = `${pos.x}% ${pos.y}%`;
      img.style.objectFit = 'contain';

      const cell = img.parentElement;
      const cellW = cell ? cell.clientWidth : 0;
      const cellH = cell ? cell.clientHeight : 0;
      let naturalW = img.naturalWidth || 0;
      let naturalH = img.naturalHeight || 0;
      const rotated = pos.rotation % 180 !== 0;
      if (rotated) {
        const tmp = naturalW;
        naturalW = naturalH;
        naturalH = tmp;
      }

      let baseCoverScale = 1;
      if (baseFit === 'cover' && cellW > 0 && cellH > 0 && naturalW > 0 && naturalH > 0) {
        const containScale = Math.min(cellW / naturalW, cellH / naturalH);
        const renderedW = naturalW * containScale;
        const renderedH = naturalH * containScale;
        baseCoverScale = Math.max(cellW / renderedW, cellH / renderedH);
      }

      const zoom = clamp(pos.zoom, 50, 250);
      let finalScale = zoom / 100;
      if (baseFit === 'cover') {
        if (zoom <= 100) {
          finalScale = 1 + ((baseCoverScale - 1) * (zoom / 100));
        } else {
          finalScale = baseCoverScale * (zoom / 100);
        }
      }

      img.style.transform = `scale(${finalScale}) rotate(${pos.rotation}deg)`;
      img.style.transformOrigin = 'center center';

      const bgImg = cell ? cell.querySelector('.photo-bg img') : null;
      if (bgImg) {
        bgImg.style.objectPosition = `${pos.x}% ${pos.y}%`;
        bgImg.style.transform = `scale(${Math.max(1.18, finalScale * 1.08)}) rotate(${pos.rotation}deg)`;
        bgImg.style.transformOrigin = 'center center';
      }
    }

    function enablePanning(cell, img, item, fitMode) {
      applyObjectPosition(img, item.id);
      cell.classList.add('is-pannable');

      const updateFromPointer = (event) => {
        const rect = cell.getBoundingClientRect();
        const x = ((event.clientX - rect.left) / rect.width) * 100;
        const y = ((event.clientY - rect.top) / rect.height) * 100;
        setCropPosition(item.id, x, y);
        applyObjectPosition(img, item.id);
      };

      const stopDragging = (event) => {
        cell.classList.remove('dragging');
        if (event.pointerId !== undefined && cell.hasPointerCapture(event.pointerId)) {
          cell.releasePointerCapture(event.pointerId);
        }
      };

      cell.addEventListener('pointerdown', (event) => {
        if (event.button !== 0) {
          return;
        }
        event.preventDefault();
        selectItem(item.id, item.name);
        cell.classList.add('dragging');
        cell.setPointerCapture(event.pointerId);
        updateFromPointer(event);
      });

      cell.addEventListener('pointermove', (event) => {
        if (!cell.classList.contains('dragging')) {
          return;
        }
        event.preventDefault();
        updateFromPointer(event);
      });

      cell.addEventListener('pointerup', stopDragging);
      cell.addEventListener('pointercancel', stopDragging);
      cell.addEventListener('dblclick', () => {
        setCropPosition(item.id, 50, 50);
        applyObjectPosition(img, item.id);
      });
    }

    function getLayoutTemplate(options, contentW, contentH) {
      const { photosPerPage, layoutTemplate } = options;
      const createGridCells = (cols, rows) => {
        const cells = [];
        for (let row = 1; row <= rows; row += 1) {
          for (let col = 1; col <= cols; col += 1) {
            cells.push({ col, row, colSpan: 1, rowSpan: 1 });
          }
        }
        return cells;
      };

      if (layoutTemplate === 'grid4') {
        return {
          label: '2 × 2 (4 zdjęcia)',
          cols: 2,
          rows: 2,
          cells: createGridCells(2, 2),
          photosPerPage: 4,
        };
      }
      if (layoutTemplate === 'grid6') {
        return {
          label: '3 × 2 (6 zdjęć)',
          cols: 3,
          rows: 2,
          cells: createGridCells(3, 2),
          photosPerPage: 6,
        };
      }
      if (layoutTemplate === 'hero5') {
        return {
          label: '1 duże + 4 małe (5 zdjęć)',
          cols: 3,
          rows: 4,
          cells: [
            { col: 1, row: 1, colSpan: 2, rowSpan: 4 },
            { col: 3, row: 1, colSpan: 1, rowSpan: 1 },
            { col: 3, row: 2, colSpan: 1, rowSpan: 1 },
            { col: 3, row: 3, colSpan: 1, rowSpan: 1 },
            { col: 3, row: 4, colSpan: 1, rowSpan: 1 },
          ],
          photosPerPage: 5,
        };
      }

      const autoGrid = chooseGrid(photosPerPage, contentW, contentH);
      return {
        label: `Auto (${autoGrid.cols} × ${autoGrid.rows})`,
        cols: autoGrid.cols,
        rows: autoGrid.rows,
        cells: createGridCells(autoGrid.cols, autoGrid.rows),
        photosPerPage,
      };
    }

    function buildPage(images, pageIndex, options) {
      const { orientation, marginMm, gapMm, fitMode, barFillMode, showLabels, layout } = options;
      const a4 = getA4SizeMm(orientation);
      const contentW = Math.max(10, a4.widthMm - (2 * marginMm));
      const contentH = Math.max(10, a4.heightMm - (2 * marginMm));
      const pageWidthPx = toPx(a4.widthMm);
      const pageHeightPx = toPx(a4.heightMm);

      const sheet = document.createElement('article');
      sheet.className = 'sheet';
      sheet.style.width = `${pageWidthPx}px`;
      sheet.style.height = `${pageHeightPx}px`;

      const number = document.createElement('div');
      number.className = 'sheet-number';
      number.textContent = `Strona ${pageIndex + 1}`;
      sheet.appendChild(number);

      const gridEl = document.createElement('div');
      gridEl.className = 'sheet-grid';
      gridEl.style.padding = `${toPx(marginMm)}px`;
      gridEl.style.gap = `${toPx(gapMm)}px`;
      gridEl.style.gridTemplateColumns = `repeat(${layout.cols}, minmax(0, 1fr))`;
      gridEl.style.gridTemplateRows = `repeat(${layout.rows}, minmax(0, 1fr))`;

      for (let i = 0; i < layout.cells.length; i += 1) {
        const cell = document.createElement('div');
        cell.className = 'photo-cell';
        cell.classList.add(`barfill-${barFillMode}`);
        const layoutCell = layout.cells[i];
        cell.style.gridColumn = `${layoutCell.col} / span ${layoutCell.colSpan}`;
        cell.style.gridRow = `${layoutCell.row} / span ${layoutCell.rowSpan}`;

        const item = images[i];
        if (item) {
          if (fitMode === 'contain' && barFillMode === 'blur') {
            const bg = document.createElement('div');
            bg.className = 'photo-bg';
            const bgImg = document.createElement('img');
            bgImg.src = item.url;
            bgImg.alt = '';
            bgImg.setAttribute('aria-hidden', 'true');
            bgImg.loading = 'eager';
            bg.appendChild(bgImg);
            cell.appendChild(bg);
          }

          const img = document.createElement('img');
          img.src = item.url;
          img.alt = item.name;
          img.dataset.itemId = item.id;
          img.dataset.fitMode = fitMode;
          img.loading = 'eager';
          img.draggable = false;
          img.className = fitMode === 'contain' ? 'fit-contain' : 'fit-cover';
          img.addEventListener('dragstart', (event) => event.preventDefault());
          img.addEventListener('load', () => applyObjectPosition(img, item.id));
          enablePanning(cell, img, item, fitMode);
          cell.dataset.itemId = item.id;
          cell.addEventListener('click', () => selectItem(item.id, item.name));
          if (selectedItemId === item.id) {
            cell.classList.add('is-selected');
          }
          cell.appendChild(img);

          if (showLabels) {
            const label = document.createElement('span');
            label.className = 'cell-label';
            label.textContent = String((pageIndex * layout.photosPerPage) + i + 1);
            cell.appendChild(label);
          }
        }

        gridEl.appendChild(cell);
      }

      sheet.appendChild(gridEl);
      return { sheet };
    }

    function releasePreviousUrls() {
      imageItems.forEach((item) => URL.revokeObjectURL(item.url));
      imageItems = [];
    }

    function readImagesFromInput(files) {
      releasePreviousUrls();
      const images = [...files]
        .filter((file) => file.type.startsWith('image/'))
        .sort(byNameAsc)
        .map((file, index) => ({
          id: file.webkitRelativePath || `${file.name}-${index}`,
          name: file.name,
          file,
          url: URL.createObjectURL(file),
        }));
      imageItems = images;
      if (selectedItemId && !imageItems.some((item) => item.id === selectedItemId)) {
        selectedItemId = null;
        selectedItemName = '';
      }
      updateSelectedCropInfo();
    }

    function getNudgeStep() {
      const value = clamp(Number(nudgeStepInput.value) || 2, 0.5, 20);
      nudgeStepInput.value = String(value);
      return value;
    }

    function nudgeSelected(dx, dy) {
      if (!selectedItemId) {
        return;
      }
      const step = getNudgeStep();
      const current = getCropPosition(selectedItemId);
      setCropPosition(selectedItemId, current.x + (dx * step), current.y + (dy * step), current.zoom, current.rotation);
      applyCropToVisibleImages(selectedItemId);
      refreshSelectionStyles();
    }

    function setSelectedZoom(zoomValue) {
      if (!selectedItemId) {
        return;
      }
      const current = getCropPosition(selectedItemId);
      setCropPosition(selectedItemId, current.x, current.y, zoomValue, current.rotation);
      applyCropToVisibleImages(selectedItemId);
    }

    function syncPhotosPerPageControl() {
      const forcedValues = {
        grid4: 4,
        grid6: 6,
        hero5: 5,
      };
      const forced = forcedValues[layoutTemplateSelect.value];
      if (!forced) {
        photosPerPageInput.disabled = false;
        return;
      }
      photosPerPageInput.value = String(forced);
      photosPerPageInput.disabled = true;
    }

    function rotateSelected(direction) {
      if (!selectedItemId) {
        return;
      }
      const current = getCropPosition(selectedItemId);
      const delta = direction === 'left' ? -90 : 90;
      setCropPosition(selectedItemId, current.x, current.y, current.zoom, current.rotation + delta);
      applyCropToVisibleImages(selectedItemId);
    }

    function getOptions() {
      syncPhotosPerPageControl();
      const photosPerPage = clamp(Number(photosPerPageInput.value) || 1, 1, 64);
      const marginMm = clamp(Number(marginInput.value) || 0, 0, 40);
      const gapMm = clamp(Number(gapInput.value) || 0, 0, 20);

      photosPerPageInput.value = String(photosPerPage);
      marginInput.value = String(marginMm);
      gapInput.value = String(gapMm);

      return {
        photosPerPage,
        orientation: orientationSelect.value,
        marginMm,
        gapMm,
        layoutTemplate: layoutTemplateSelect.value,
        fitMode: fitModeSelect.value,
        barFillMode: barFillModeSelect.value,
        showLabels: showLabelsSelect.value === 'yes',
      };
    }

    function render() {
      setError('');
      pagesEl.innerHTML = '';

      if (!imageItems.length) {
        metaEl.innerHTML = 'Brak załadowanych zdjęć. Wybierz folder, aby rozpocząć.';
        return;
      }

      const options = getOptions();
      if (options.marginMm * 2 >= Math.min(...Object.values(getA4SizeMm(options.orientation)))) {
        setError('Margines jest zbyt duży dla formatu A4. Zmniejsz wartość.');
        return;
      }

      const a4 = getA4SizeMm(options.orientation);
      const contentW = Math.max(10, a4.widthMm - (2 * options.marginMm));
      const contentH = Math.max(10, a4.heightMm - (2 * options.marginMm));
      const layout = getLayoutTemplate(options, contentW, contentH);
      const renderOptions = { ...options, layout };

      const chunks = chunkArray(imageItems, layout.photosPerPage);
      chunks.forEach((group, pageIndex) => {
        const { sheet } = buildPage(group, pageIndex, renderOptions);
        pagesEl.appendChild(sheet);
      });
      refreshSelectionStyles();
      updateSelectedCropInfo();

      metaEl.innerHTML = [
        `<strong>Zdjęcia:</strong> ${imageItems.length}`,
        `<strong>Kartek A4:</strong> ${chunks.length}`,
        `<strong>Układ:</strong> ${layout.label} (${layout.photosPerPage} zdjęć/stronę)`,
        `<strong>Orientacja:</strong> ${options.orientation === 'portrait' ? 'pionowa' : 'pozioma'}`,
      ].join('<br>');
    }

    function updatePageRule() {
      const styleTagId = 'dynamic-print-page-size';
      const existing = document.getElementById(styleTagId);
      if (existing) {
        existing.remove();
      }

      const style = document.createElement('style');
      style.id = styleTagId;
      const orientation = orientationSelect.value;
      style.textContent = `@media print { @page { size: A4 ${orientation}; margin: 0; } }`;
      document.head.appendChild(style);
    }

    async function waitForImagesBeforePrint() {
      const images = [...pagesEl.querySelectorAll('img')];
      const waits = images.map((img) => new Promise((resolve) => {
        const done = () => resolve();

        if (img.complete && img.naturalWidth > 0) {
          if (typeof img.decode === 'function') {
            img.decode().then(done).catch(done);
          } else {
            done();
          }
          return;
        }

        const onLoad = () => {
          img.removeEventListener('load', onLoad);
          img.removeEventListener('error', onError);
          if (typeof img.decode === 'function') {
            img.decode().then(done).catch(done);
          } else {
            done();
          }
        };
        const onError = () => {
          img.removeEventListener('load', onLoad);
          img.removeEventListener('error', onError);
          done();
        };
        img.addEventListener('load', onLoad, { once: true });
        img.addEventListener('error', onError, { once: true });
      }));

      await Promise.all(waits);
    }

    folderInput.addEventListener('change', (event) => {
      const files = event.target.files;
      if (!files || !files.length) {
        releasePreviousUrls();
        updateFolderStatus(null, 0);
        render();
        return;
      }

      readImagesFromInput(files);
      updateFolderStatus(files, imageItems.length);
      render();
    });

    [photosPerPageInput, orientationSelect, marginInput, gapInput, fitModeSelect, barFillModeSelect, showLabelsSelect, layoutTemplateSelect]
      .forEach((control) => control.addEventListener('change', render));

    renderBtn.addEventListener('click', render);
    printBtn.addEventListener('click', async () => {
      updatePageRule();
      await waitForImagesBeforePrint();
      window.print();
    });
    resetCropBtn.addEventListener('click', () => {
      imageItems.forEach((item) => setCropPosition(item.id, 50, 50, 100, 0));
      render();
    });
    nudgeUpBtn.addEventListener('click', () => nudgeSelected(0, 1));
    nudgeDownBtn.addEventListener('click', () => nudgeSelected(0, -1));
    nudgeLeftBtn.addEventListener('click', () => nudgeSelected(1, 0));
    nudgeRightBtn.addEventListener('click', () => nudgeSelected(-1, 0));
    zoomRangeInput.addEventListener('input', () => {
      zoomValueInput.value = zoomRangeInput.value;
      setSelectedZoom(Number(zoomRangeInput.value));
    });
    zoomValueInput.addEventListener('change', () => {
      const value = clamp(Number(zoomValueInput.value) || 100, 50, 250);
      zoomValueInput.value = String(value);
      zoomRangeInput.value = String(value);
      setSelectedZoom(value);
    });
    rotateLeftBtn.addEventListener('click', () => rotateSelected('left'));
    rotateRightBtn.addEventListener('click', () => rotateSelected('right'));
    resetSelectedCropBtn.addEventListener('click', () => {
      if (!selectedItemId) {
        return;
      }
      setCropPosition(selectedItemId, 50, 50, 100, 0);
      applyCropToVisibleImages(selectedItemId);
      refreshSelectionStyles();
    });

    window.addEventListener('beforeunload', () => {
      persistCropPositionsNow();
      releasePreviousUrls();
    });

    loadCropPositionsFromStorage();
    updateSelectedCropInfo();
    setNudgeButtonsDisabled(true);
    syncPhotosPerPageControl();
    updateFolderStatus(null, 0);
    render();
  </script>
</body>
</html>
